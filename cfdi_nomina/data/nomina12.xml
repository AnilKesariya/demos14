<cfdi:Comprobante
    xsi:schemaLocation="http://www.sat.gob.mx/cfd/3 http://www.sat.gob.mx/sitio_internet/cfd/3/cfdv33.xsd http://www.sat.gob.mx/nomina12 http://www.sat.gob.mx/sitio_internet/cfd/nomina/nomina12.xsd"
    xmlns:cfdi="http://www.sat.gob.mx/cfd/3"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:nomina12="http://www.sat.gob.mx/nomina12"
    Version="3.3"
    {% if serie %} Serie="{{ serie }}" {% endif %}
    {% if number %} Folio="{{ number }}" {% endif %}
    Fecha="{{ date_invoice_tz }}"
    Sello=""
    FormaPago="99"
    NoCertificado="{{ certificate_number }}"
    Certificado="{{ certificate }}"
    {% if conditions %} CondicionesDePago="{{ conditions }}" {% endif %}
    SubTotal="{{ subtotal or 0.0 }}"
    {% if discount_amount %} Descuento="{{ discount_amount }}" {% endif %}
    Moneda="{{ currency }}"
    {% if rate %} TipoCambio="{{ rate }}" {% endif %}
    Total="{{ amount_total or 0.0}}"
    TipoDeComprobante="{{ document_type }}"
    MetodoPago="PUE"
    {% if emitter_zip %} LugarExpedicion="{{ emitter_zip }}" {% endif %}
    {% if confirmation %} Confirmacion="{{ confirmation }}" {% endif %}>
    {% if cfdi_related_type %}
        <cfdi:CfdiRelacionados
            TipoRelacion="{{ cfdi_related_type }}">
            {% for cfdi in cfdi_related %}
                <cfdi:CfdiRelacionado UUID="{{ cfdi.uuid }}"/>
            {% endfor %}
        </cfdi:CfdiRelacionados>
    {% endif %}
    <cfdi:Emisor
        Rfc="{{ emitter_rfc }}"
        Nombre="{{ emitter_name }}"
        RegimenFiscal="{{ emitter_fiscal_position or ''  }}"/>
    <cfdi:Receptor
        Rfc="{{ receiver_rfc }}"
        {% if receiver_name %} Nombre="{{ receiver_name }}" {% endif %}
        {% if receiver_country %} ResidenciaFiscal="{{ receiver_country }}" {% endif %}
        {% if receiver_reg_trib %} NumRegIdTrib="{{ receiver_reg_trib }}" {% endif %}
        UsoCFDI="P01"/>
    <cfdi:Conceptos>
        <cfdi:Concepto
            ClaveProdServ="84111505"
            Cantidad="1"
            ClaveUnidad="ACT"
            Descripcion="Pago de nómina"
            ValorUnitario="{{ concept_price_unit or 0.0 }}"
            {% if discount_amount %} Descuento="{{ discount_amount  }}" {% endif %}
            Importe="{{ concept_subtotal_wo_discount or 0.0 }}"/>
    </cfdi:Conceptos>
    {% set pay = payroll %}
    <cfdi:Complemento>
        <nomina12:Nomina
            Version="1.2"
            TipoNomina="{{ pay.type }}"
            FechaPago="{{ pay.payment_date }}"
            FechaInicialPago="{{ pay.date_from }}"
            FechaFinalPago="{{ pay.date_to }}"
            NumDiasPagados="{{ pay.number_of_days }}"
            {% if pay.total_perceptions %} TotalPercepciones="{{ pay.total_perceptions }}" {% endif %}
            {% if pay.total_deductions and pay.total_deductions != "0.00" %} TotalDeducciones="{{ pay.total_deductions }}" {% endif %}
            {% if pay.other_payments %} TotalOtrosPagos="{{ pay.total_other }}" {% endif %}>
            <nomina12:Emisor
                {% if pay.curp_emitter %} Curp="{{ pay.curp_emitter }}" {% endif %}
                {% if pay.employer_register %} RegistroPatronal="{{ pay.employer_register }}" {% endif %}
                {% if pay.vat_emitter %} RfcPatronOrigen="{{ pay.vat_emitter }}" {% endif %}>
                {% if pay.source_sncf %}
                <nomina12:EntidadSNCF
                    OrigenRecurso="{{ pay.source_sncf }}"
                    {% if pay.amount_sncf %} MontoRecursoPropio="{{ pay.amount_sncf }}" {% endif %}/>
                {% endif %}
            </nomina12:Emisor>
            <nomina12:Receptor
                {% if pay.curp_emp %} Curp="{{ pay.curp_emp }}" {% endif %}
                {% if pay.nss_emp %} NumSeguridadSocial="{{ pay.nss_emp }}" {% endif %}
                FechaInicioRelLaboral="{{ pay.date_start }}"
                Antigüedad="{{ pay.seniority_emp }}"
                {% if pay.contract_type %} TipoContrato="{{ pay.contract_type }}" {% endif %}
                Sindicalizado="{{ pay.emp_syndicated }}"
                {% if pay.working_day %} TipoJornada="{{ pay.working_day }}" {% endif %}
                {% if pay.emp_regimen_type %} TipoRegimen="{{ pay.emp_regimen_type }}" {% endif %}
                NumEmpleado="{{ pay.no_emp }}"
                Departamento="{{ pay.departament }}"
                Puesto="{{ pay.emp_job }}"
                {% if pay.emp_risk %} RiesgoPuesto="{{ pay.emp_risk }}" {% endif %}
                {% if pay.payment_periodicity %} PeriodicidadPago="{{ pay.payment_periodicity }}" {% endif %}
                {% if pay.emp_bank %} Banco="{{ pay.emp_bank }}" {% endif %}
                {% if pay.emp_account %} CuentaBancaria="{{ pay.emp_account }}" {% endif %}
                {% if not pay.asimilado_salario %}
                SalarioBaseCotApor="{{ pay.emp_base_salary }}"
                SalarioDiarioIntegrado="{{ pay.emp_diary_salary }}"
                {% endif %}
                {% if pay.emp_state %} ClaveEntFed="{{ pay.emp_state }}" {% endif %}>
                {% for out in pay.outsourcing%}
                    <nomina12:SubContratacion
                        RfcLabora="{{ pay.vat_outsourcing }}"
                        PorcentajeTiempo="{{ pay.porcent_outsourcing }}"/>
                {% endfor %}
            </nomina12:Receptor>
            {% if pay.total_perceptions %}
                <nomina12:Percepciones
                    TotalSueldos="{{ pay.total_salaries }}"
                    {% if pay.total_compensation %} TotalSeparacionIndemnizacion="{{ pay.total_compensation }}" {%endif%}
                    {% if pay.total_retirement %} TotalJubilacionPensionRetiro="{{ pay.total_retirement }}" {%endif%}
                    TotalGravado="{{ pay.total_taxed }}"
                    TotalExento="{{ pay.total_exempt }}">
                    {% for perception in pay.perceptions %}
                        <nomina12:Percepcion
                            TipoPercepcion="{{ perception.type }}"
                            Clave="{{ perception.key }}"
                            Concepto="{{ perception.concept }}"
                            ImporteGravado="{{ perception.amount_g or 0.0 }}"
                            ImporteExento="{{ perception.amount_e or 0.0 }}">
                            {% if perception.action %}
                                <nomina12:AccionesOTitulos
                                    ValorMercado="{{ perception.action.value }}"
                                    PrecioAlOtorgarse="{{ perception.action.price }}"/>
                            {% endif %}
                            {% for extra in perception.extra_hours %}
                                <nomina12:HorasExtra
                                    Dias="{{ extra.days }}"
                                    TipoHoras="{{ extra.type }}"
                                    HorasExtra="{{ extra.hours }}"
                                    ImportePagado="{{ extra.amount }}"/>
                            {% endfor %}
                        </nomina12:Percepcion>
                    {% endfor %}
                    {% if pay.total_retirement %}
                        <nomina12:JubilacionPensionRetiro
                            {% if pay.retirement_one_ex %} TotalUnaExhibicion="{{ pay.retirement_one_ex }}" {% endif %}
                            {% if pay.retirement_partiality %} TotalParcialidad="{{ pay.retirement_partiality }}" {% endif %}
                            {% if pay.retirement_amount_diary %} MontoDiario="{{ pay.retirement_amount_diary }}" {% endif %}
                            IngresoAcumulable="{{ pay.retirement_cumulative }}"
                            IngresoNoAcumulable="{{ pay.retirement_no_cumulative }}"/>
                    {% endif %}
                    {% if pay.total_compensation %}
                        <nomina12:SeparacionIndemnizacion
                            TotalPagado="{{ pay.compensation_paid }}"
                            NumAñosServicio="{{ pay.compensation_years }}"
                            UltimoSueldoMensOrd="{{ pay.compensation_last_salary }}"
                            IngresoAcumulable="{{ pay.compensation_cumulative }}"
                            IngresoNoAcumulable="{{ pay.compensation_no_cumulative }}"/>
                    {% endif %}
                </nomina12:Percepciones>
            {% endif %}
            {% if pay.total_deductions is defined and pay.deductions|length > 0 %}
                <nomina12:Deducciones
                    {% if pay.total_other_deductions %} TotalOtrasDeducciones="{{ pay.total_other_deductions }}" {% endif %}
                    {% if pay.show_total_taxes_withheld == True %} TotalImpuestosRetenidos="{{ pay.total_taxes_withheld }}" {% endif %}>
                    {% for deduction in pay.deductions %}
                        <nomina12:Deduccion
                            TipoDeduccion="{{ deduction.type }}"
                            Clave="{{ deduction.key }}"
                            Concepto="{{ deduction.concept }}"
                            Importe="{{ deduction.amount }}"/>
                    {% endfor %}
                </nomina12:Deducciones>
            {% endif %}
            {% if pay.other_payments %}
                <nomina12:OtrosPagos>
                {% for payment in pay.other_payments %}
                    <nomina12:OtroPago
                        TipoOtroPago="{{ payment.type }}"
                        Clave="{{ payment.key }}"
                        Concepto="{{ payment.concept }}"
                        Importe="{{ payment.amount }}">
                        {% if payment.subsidy %}
                            <nomina12:SubsidioAlEmpleo
                                SubsidioCausado="{{ payment.subsidy }}"/>
                        {% endif %}
                        {% if payment.compensation %}
                            <nomina12:CompensacionSaldosAFavor
                                SaldoAFavor="{{ payment.compensation.amount }}"
                                Año="{{ payment.compensation.year }}"
                                RemanenteSalFav="{{ payment.compensation.rem }}"/>
                        {% endif %}
                    </nomina12:OtroPago>
                {% endfor %}
                </nomina12:OtrosPagos>
            {% endif %}
            {% if pay.inabilities %}
                <nomina12:Incapacidades>
                    {% for inability in pay.inabilities%}
                        <nomina12:Incapacidad
                            DiasIncapacidad="{{ inability.days }}"
                            TipoIncapacidad="{{ inability.type }}"/>
                    {% endfor %}
                </nomina12:Incapacidades>
            {% endif %}
        </nomina12:Nomina>
    </cfdi:Complemento>
</cfdi:Comprobante>
